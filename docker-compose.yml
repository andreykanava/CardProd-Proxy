services:
  edge-net:
    build: ./edge-net
    container_name: edge-net
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - /lib/modules:/lib/modules:ro
      - ./wireguard:/etc/wireguard:rw
      - ./agent-data:/data
    env_file:
      - .env
    command: ["./entrypoint.sh"]
    healthcheck:
      test: ["CMD-SHELL", "wg show wg0 >/dev/null 2>&1"]
      interval: 5s
      timeout: 2s
      retries: 30

  traefik:
    image: traefik:v3.1
    container_name: edge-traefik
    restart: unless-stopped
    network_mode: host
    depends_on:
      edge-net:
        condition: service_healthy
    command:
      - --api.dashboard=false
      - --entryPoints.web.address=:80
      - --entryPoints.websecure.address=:443
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
      - --log.level=INFO
    volumes:
      - ./traefik/dynamic:/etc/traefik/dynamic:rw
      - ./traefik/acme:/acme:rw

  proxy-agent:
    build: ./proxy-agent
    container_name: edge-agent
    restart: unless-stopped
    network_mode: host
    depends_on:
      edge-net:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - AGENT_TOKEN=${AGENT_TOKEN}
      - TRAEFIK_DYNAMIC_DIR=/etc/traefik/dynamic
      - STATE_FILE=/data/state.json
      - TRAEFIK_ENTRYPOINT=websecure
      - TRAEFIK_CERTRESOLVER=dnsresolver
    volumes:
      - ./traefik/dynamic:/etc/traefik/dynamic:rw
      - ./agent-data:/data:rw
